import os
from openai import OpenAI
from tools.code_reader import get_project_codebase

# --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
CLIENT = OpenAI(
    base_url="http://localhost:11434/v1",
    api_key="lm-studio"
)

MODEL_NAME = "mistral-large:123b"

# –®–ª—è—Ö –¥–æ –∫–æ–¥—É. 
TARGET_DIR = os.path.join(".", "app", "src") 
OUTPUT_FILE = "1_technical_report.md"

def run_technical_audit():
    print(f"ü§ñ Agent 'TechLead' –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –Ω–∞ {MODEL_NAME}...")
    
    # --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü—Ä–∏–±—Ä–∞–Ω–æ verbose=True ---
    project_data = get_project_codebase(TARGET_DIR)
    
    if not project_data["full_content"]:
        print(f"‚ùå –ü–û–ú–ò–õ–ö–ê: –£ –ø–∞–ø—Ü—ñ '{TARGET_DIR}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª—ñ–≤ –∫–æ–¥—É.")
        print("   –ü–µ—Ä–µ–≤—ñ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫. –ú–æ–∂–ª–∏–≤–æ —Ç—Ä–µ–±–∞ –∑–º—ñ–Ω–∏—Ç–∏ TARGET_DIR –Ω–∞ './lib'?")
        return

    # 2. –ü—Ä–æ–º–ø—Ç "Anti-Hallucination"
    system_prompt = """
    –¢–ò ‚Äî –°–£–í–û–†–ò–ô –¢–ï–•–ù–Ü–ß–ù–ò–ô –ê–£–î–ò–¢–û–†. –¢–≤–æ—è –º–µ—Ç–∞ ‚Äî –æ–ø–∏—Å–∞—Ç–∏ –¢–Ü–õ–¨–ö–ò —Ç–µ, —â–æ —Ä–µ–∞–ª—å–Ω–æ —ñ—Å–Ω—É—î –≤ –∫–æ–¥—ñ.
    
    –ü–†–ê–í–ò–õ–ê (Strict Rules):
    1. GROUNDING: –ö–æ–∂–Ω–µ —Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–∞—î –±–∞–∑—É–≤–∞—Ç–∏—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ñ–∞–π–ª—ñ. –Ø–∫—â–æ —Ç–∏ –æ–ø–∏—Å—É—î—à —Ñ—É–Ω–∫—Ü—ñ—é, –≤–∫–∞–∂–∏ (—Ñ–∞–π–ª: ...).
    2. NO HALLUCINATIONS: –Ø–∫—â–æ —Ç–∏ –Ω–µ –±–∞—á–∏—à —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó —è–∫–æ—ó—Å—å —Ñ—É–Ω–∫—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–ø—Ä–æ–≥—Ä–∞–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç—ñ"), –ø–∏—à–∏ —á—ñ—Ç–∫–æ: "–£ –Ω–∞–¥–∞–Ω–æ–º—É –∫–æ–¥—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –í–Ü–î–°–£–¢–ù–Ø". –ù–µ –¥–æ–¥—É–º—É–π, —è–∫ –±–∏ –≤–æ–Ω–∞ –º–æ–≥–ª–∞ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.
    3. SCOPE: –Ü–≥–Ω–æ—Ä—É–π —Å—Ç–∏–ª—ñ (CSS/UI), —Ñ–æ–∫—É—Å—É–π—Å—è –Ω–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ—Ü—ñ (functions, classes, logic).

    –ó–ê–í–î–ê–ù–ù–Ø: –°—Ñ–æ—Ä–º—É–π –∑–≤—ñ—Ç Markdown –∑–∞ –ø—É–Ω–∫—Ç–∞–º–∏:
    
    1. **–¢–µ—Ö–Ω—ñ—á–Ω–∏–π —Å—Ç–µ–∫ —Ç–∞ –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞**: –Ø–∫—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó —Ä–µ–∞–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ —ñ–º–ø–æ—Ä—Ç–∞—Ö?
    2. **–ú–µ—Ö–∞–Ω—ñ–∫–∞ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è**: –ü—Ä–æ—Å–ª—ñ–¥–∫—É–π –ª–∞–Ω—Ü—é–∂–æ–∫ –∫–æ–¥—É: —è–∫ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è? –ß–∏ —î –≤—Å—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ª–æ–≥—ñ–∫–∏ (–≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è, —Å–ª–æ—Ç–∏)?
    3. **–¶—ñ–Ω–æ–≤–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ –≤ –∫–æ–¥—ñ**: –ß–∏ —î –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∂–µ–Ω—ñ —Ü—ñ–Ω–∏ (—Ü–∏—Ñ—Ä–∏)? –ß–∏ —î –∑–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–Ω–∏–∂–æ–∫? (–¶–∏—Ç—É–π –∑–º—ñ–Ω–Ω—ñ).
    4. **–†–æ–ª—å–æ–≤–∞ –º–æ–¥–µ–ª—å**: –ß–∏ —î –≤ –∫–æ–¥—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ (isAdmin, isBarber)? –Ø–∫ —Ü–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ?
    
    5. **–†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–Ø (–¢–≤–æ—Ä—á–∞ —á–∞—Å—Ç–∏–Ω–∞)**:
       –¢—ñ–ª—å–∫–∏ –≤ —Ü—å–æ–º—É –ø—É–Ω–∫—Ç—ñ —Ç–∏ –º–æ–∂–µ—à –ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –Ω–æ–≤–µ.
       –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è "Virtual Accountant" —É –ø–∞–Ω–µ–ª—ñ –∞–¥–º—ñ–Ω–∞. 
       –ù–∞–ø–∏—à–∏ –ø—Å–µ–≤–¥–æ–∫–æ–¥ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫–∞ —Ä–∞—Ö—É—î: (–í—Å—å–æ–≥–æ –≥–æ—Ç—ñ–≤–∫–∏ - –í–∏—Ç—Ä–∞—Ç–∏ –±–∞—Ä–±–µ—Ä–∞) * %–ö–æ–º—ñ—Å—ñ—ó.
    """

    user_message = f"""
    –û—Å—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤:
    {project_data['structure']}
    
    –û—Å—å –ø–æ–≤–Ω–∏–π –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É:
    {project_data['full_content']}
    """

    print(f"üß† –ù–∞–¥—Å–∏–ª–∞—é {len(project_data['full_content'])} —Å–∏–º–≤–æ–ª—ñ–≤ —É {MODEL_NAME}...")

    try:
        response = CLIENT.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            temperature=0.0, # –ù–£–õ–¨–û–í–ê —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ñ–∞–∫—Ç—ñ–≤
        )
        
        report_content = response.choices[0].message.content

        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write(report_content)
            
        print(f"‚úÖ –£—Å–ø—ñ—Ö! –ó–≤—ñ—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É: {OUTPUT_FILE}")
        
    except Exception as e:
        print(f"üî• –ü–æ–º–∏–ª–∫–∞ API: {e}")

if __name__ == "__main__":
    run_technical_audit()